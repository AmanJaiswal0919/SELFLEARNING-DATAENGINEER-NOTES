Types of Subqueries in SQL (with examples and flow)

1. Scalar Subquery
Definition:
Returns exactly one row and one column (single value).
Used in: SELECT, WHERE, HAVING

Example: Find employees earning more than company average salary?
empname    salary    deptid
Aman       5000        1
Neha       6000        1
Ravi       4000        2
Sara       8000        2
SELECT empname
FROM employees e
WHERE e.salary > (
    SELECT AVG(salary)
    FROM employees
);

Flow of execution:

Step 1: Subquery executes first
SELECT AVG(salary) FROM employees;
Subquery Output:
5000

Step 2: Main query executes
SELECT empname, salary
FROM employees
WHERE e.salary (5000,6000,4000,8000)>5000

Final Output:
Ravi   
Sara   

2. Correlated Subquery
Definition:
Depends on outer query value.
Runs once for every row of outer query.

Example: Find employees earning more than their department average salary?
empname    salary    deptid
Aman       5000        1
Neha       6000        1
Ravi       4000        2
Sara       8000        2

SELECT empname
FROM employees e
WHERE e.salary > (
    SELECT AVG(salary)
    FROM employees
    WHERE deptid = e.deptid
);

Flow of execution:

a) For Aman (e.deptid=1)
a-1)SELECT AVG(salary)
FROM employees
WHERE deptid=1
5000+6000/2=5500
a-2)SELECT empname
FROM employees e
WHERE e.salary(5000)> 5500 = False
b) For Neha (e.deptid=1)
b-1)SELECT AVG(salary)
FROM employees
WHERE deptid=1
5000+6000/2=5500
b-2)SELECT empname
FROM employees e
WHERE e.salary(6000)> 5500 = True

c) For Ravi (e.deptid=2)
c-1)SELECT AVG(salary)
FROM employees
WHERE deptid=2
4000+8000/2=6000
c-2)SELECT empname
FROM employees e
WHERE e.salary(4000)> 6000 = False
d) For Sara (e.deptid=2)
d-1)SELECT AVG(salary)
FROM employees
WHERE deptid=2
4000+8000/2=6000
d-2)SELECT empname
FROM employees e
WHERE e.salary(8000)> 5500 = True

Final Output:
Ravi  
Sara  

3. Table Subquery
Definition:
Returns multiple rows and multiple columns
Used in FROM clause.
Example: Departments having more than 5 employees?
SELECT deptid
FROM (
    SELECT deptid, COUNT(*) AS cnt
    FROM employees
    GROUP BY deptid
) table
WHERE cnt > 5;

Flow of execution:
Step 1: Subquery executes first
SELECT deptid, COUNT(*) AS cnt
    FROM employees
    GROUP BY deptid
Subquery Output:
table
deptid   cnt
10        3
20        8
30        5
40       12
Step 2: Main query executes
SELECT deptid
FROM table
WHERE cnt > 5;
Final Output:
20
40

4. Column Subquery
Definition:
Returns single column but multiple rows
Used with:
IN
ANY
ALL
Example: Employees working in Delhi departments?
SELECT empname, deptid
FROM employees
WHERE deptid IN (
    SELECT deptid
    FROM department
    WHERE location = 'DELHI'
);


Flow of execution:
Step 1: Subquery executes first
SELECT deptid
    FROM department
    WHERE location = 'DELHI'
Subquery Output:
10
30
Step 2: Main query executes
SELECT empname, deptid
FROM employees
WHERE deptid IN (10,30);
Final Output:
A   10
C   30

5. Row Subquery
Definition:
Returns one or more rows with multiple columns
Example: Highest salary in each department?
SELECT empname, deptid, salary
FROM employees
WHERE (deptid, salary) IN (
    SELECT deptid, MAX(salary)
    FROM employees
    GROUP BY deptid
);

Flow of execution:
Step 1: Subquery executes first
SELECT deptid, MAX(salary)
    FROM employees
    GROUP BY deptid
Subquery Output:
10   6000
20   8000
Step 2: Main query executes
SELECT empname, deptid, salary
FROM employees
WHERE (deptid, salary) IN (10   6000,20   8000);
Final Output:
Ravi   10   6000
Sara   20   8000

6. Nested Subquery
Definition:
Subquery inside another subquery
Example: Customers whose order count is above average order count?

SELECT custid,
FROM orders
GROUP BY custid
HAVING COUNT(*) > (
    SELECT AVG(cnt)
    FROM (
        SELECT COUNT(*) AS cnt
        FROM orders
        GROUP BY custid
    ) table
);

Flow of execution:
Step 1: Subquery executes first
SELECT COUNT(*) AS cnt,custid
        FROM orders
        GROUP BY custid
Subquery Output:
table
cnt  custid
2      1
5      2
3      3
10     4
Step 2: Subquery executes Second
SELECT AVG(cnt)
FROM table
Subquery Output:
5
Step 2: Main query executes
SELECT COUNT(*) > 5 AS cnt
FROM orders
GROUP BY custid
HAVING COUNT(*) > 5 AS cnt
Subquery Output:
cnt
10
Final Output:
4

a) Find top3 departments with highest average salary only for departments having at least 5 employees?

highest average salary only for departments having at least 5 employees (average salary, at least 5 employees aggregate function required here you can it is asking more than 1 employee means multiple employee belong to same department means department will be duplicate category value so groupby required)

SELECT AVG(salary), department
FROM employees
GROUP BY department
HAVING COUNT (empid) >= 5;
-Find top3 departments
ORDER BY avgsalary DESC (highest to lowest)
LIMIT 3; (return top3 result)

b) Find the second highest selling product based on total sales amount? (total sales aggregate function required here in sql product based on total sales amount always means total sales amount per product means product will be duplicate category value so groupby required)
SELECT SUM(amount), product
FROM sales
GROUP BY product;
-Find the second highest ORDER BY totalsales DESC (highest to lowest)
LIMIT 1 OFFSET 1; (skip ist b/c offset is 1 then return 2nd b/c now 2nd is on top as limit is 1)

c) Customers who placed more than 10 orders, sorted by order count, return rank 6-18 only?(more than 10 aggregation function required here you can see that it is asking more than 18 orders means the same customer ordered multiple times means customer will be duplicate category value so groupby required)

SELECT COUNT(*) AS ordercount, Customer
FROM orders
GROUP BY Customer
HAVING ordercount>10;
-Sorted by order count, Return rank 6-18 only
ORDER BY ordercount DESC (highest to lowest)
LIMIT 5 OFFSET 5; (skip 5. b/c offset is 5 then return 6-10 b/c now 6-10 is on top as limit is 5)

d) Top 5 cities with the highest number of employees, only cities with more than 20 employees? (more than 10 aggregation function required here you can see that it is asking more than 20 employees means the multiple employees from within same city city will be duplicate category value so groupby required)

SELECT city, COUNT(*) AS employeecount
FROM employees
GROUP BY city
HAVING employeecount>20;
-Top 5 cities
ORDER BY employeecount DESC (highest to lowest)
LIMIT 5; (return top5 result)

e) Find 3 months with the lowest total revenue, excluding months where revenue < 10,000? (total revenue aggregation function required filtering < 10000 based on total revenue (aggregation value) so whenever filtering based on aggregated value Having is used so with having groupBy used)
Here full date is not duplicate but month is so we did grouping based on same month here

SELECT SUM(amount) AS totalrevenue, MONTH(paymentdate) AS month
FROM payments
GROUP BY MONTH (paymentdate)
HAVING totalrevenue>=10000
-Find 3 months with lowest revenue
ORDER BY totalrevenue ASC
LIMIT 3;
input - paymemntid   paymentdate   amount 
output flow
totalrevenue  month
6000+5000     Jan(1)
4000+3000     Feb(2)
12000         Mar(3)
8000+3000     Apr(4)
15000         May(5)
Find 3 months 
totalrevenue    month 
11000              1
11000              4
12000              3




